---
theme: './theme'
title: toCスタートアップにおけるDDD・クリーンアーキテクチャ取捨選択集
info: |
  DDDのリアルを話します。 Twitter: @meijin_garden
highlighter: shiki
drawings:
  persist: false
transition: slide-left
mdc: true
layout: cover
colorSchema: light
fonts:
  # basically the text
  sans: M PLUS 2
  # use with `font-serif` css class from UnoCSS
  serif: Robot Slab
  # for code blocks, inline code, etc.
  mono: Fira Code
  weights: 200, 400, 700
---

# DDDを志して3年経ったら<br />「DDDの皮を被ったクリーンアーキテクチャ」<br />になった話

## 株式会社NoSchool CTO / meijin

---

# 目次

1. TL; DR
2. 自己紹介「私とアーキテクチャの関わり」
3. 事業紹介「関わってきた事業とアーキテクチャ」
4. DDDやクリーンアーキテクチャに対するスタンス
5. 実際の取捨選択事例集
6. まとめ

---
layout: section
---

# TL; DR

---

# TL; DR

よくある取り組みや設計ルールに対して<br>
- 「無視していること」<br> 「遵守していること」<br> 「バランスを取っていること」<br>

をそれぞれ事業・組織・プロダクト特性などの観点から説明します。

- つまり
  - アーキテクチャ論でよく聞く「要はバランス」の具体例を徹底的に解説します！


---
layout: section
---

# 自己紹介・事業紹介

---

# 自己紹介（登壇者1人目：名人）

- 職種・SNS
  - 株式会社NoSchool CTO
  - 新卒4年目でスタートアップのCTOになって5年経ちました
  - Twitter(X): [名人｜マナリンクCTO](https://twitter.com/meijin_garden)
  - Zenn: https://zenn.dev/meijin
  - 好きな言語はTypeScript、好きなHTTPヘッダーはCache-Control
- 趣味
  - 将棋☗、カメラ📸、ラム酒🥃、個人開発💻、筋トレ💪、高校野球観戦⚾

<div class="absolute top-12 right-8">
<img class="w-48 h-48 rounded-full" src="https://github.com/TeXmeijin/vite-react-ts-tailwind-firebase-starter/assets/7464929/09bd0b32-0bcc-4f0d-849a-ccfdd46713ba" alt="">
</div>

---

# 自己紹介（登壇者2人目：Kondo）

TODO

---
layout: section
---

# 私とアーキテクチャの関わり

設計思想について語るとき、私自身の経験・経歴と切っては切り離せないと思いました。<br>「私とアーキテクチャの関わり」と題して、私の経歴や開発してきたこと、試したこと、考えたことを<br>まとめていきます。

---

# ざっくり経歴

- 2016年〜2019年：新卒入社して3年間
  - フロントエンド大好き！数百万件処理する大規模バッチのメンテ大変！
- 2019年：転職＆DDDとの出会い
  - 設計が分からなさすぎて一瞬で可読性ゼロのコードを量産＆DDDを学びトライアンドエラー
- 2020年：ピボットを経て起死回生
  - 事業が上手くいかなくて会社が潰れかけるが、オンライン家庭教師サービスで起死回生
- 2024年 設計水準を一定保ちながら事業成長を続けている
  - 4月入社のEMから「”耐え”と”耐えてない”のラインが絶妙に設計されている」と評される

---

# 2016年〜2019年：新卒入社して3年間

- もともと私はどんな人間か
  - プロダクト開発大好き。学生時代から個人開発ソフトをクラスメイトに配ってた
  - 1人開発しかやったことなくて、Main.cppに1200行書いたり日本語変数名使ってた
- 新卒入社して3年間
  - フロントエンドが楽しくて、JavaScriptでPubSub実装したりCSSで模写していた
  - とはいえフルスタック志向なので拙いなりにインフラからフロントエンドまでできた
  - 20年物のWebサービス開発なのでモダンなアーキテクチャは当時あまり無かった
  - 社内新規事業提案が採択されたので、プロトタイプ開発とスーツ着て営業を1年ほどやった

---

# 2019年：転職＆DDDとの出会い

- スタートアップCTOに転職
  - もともと教育サービスを自分で立ち上げるか、CTOになりたかったが、社内新規事業で1年間自分で営業と開発両方やって大変だったので、CTOになることにした
- 技術力なさ過ぎ問題
  - フルスタックだと思っていたが、自分1人でサービス立ち上げとなると実力不足すぎた
  - 知識を増やそう増やそうとしているうちに、俗に言う「クソコード」が量産された
- DDDとの出会い
  - 社運が掛かった有料課金機能の実装時に、自分の実装が信用できなさすぎて、設計手法の学習とテストコードの拡充を始める。形だけの実装パターンの踏襲（戦術DDD）を始める

---

# 学んで速攻で実践＆記事化

CTOになって半年。ORM依存の設計でバグを起こしまくったので改善した知見を詰め込んだ。<br>結果として300Like超をいただきモチベーションになる。

- [Laravelでドメイン駆動設計(DDD)を実践し、Eloquent Model依存の設計から脱却する](https://qiita.com/mejileben/items/302a9f502ca0801b1efb)

<img class="border border-gray-300 rounded-lg" width="490" alt="CleanShot 2024-07-08 at 17.47.50.png (78.7 kB)" src="https://img.esa.io/uploads/production/attachments/17780/2024/07/08/104467/ec30d577-a51d-4039-aeae-6da7bbf40258.png">


---

# 2020年：ピボットを経て起死回生

- 創業事業が伸びずクローズ。新たにオンライン家庭教師事業を立ち上げ
  - 具体的には”来月CTOの給料出せないかも”くらい追い詰められた
  - コロナ禍を迎えており、オンライン家庭教師事業を立案することで資金調達して乗り切る
- 当時の私の感情
  - 事業が終わった原因は何？クソコードによるバグが足を引っ張ったかもしれないし、社運が掛かった事業で呑気にDDDにチャレンジしていたからかもしれないし、韓国から競合が参入してきたせいかもしれないし、最初のコンセプトから終わっていた可能性だってある
  - 分からんからこそ「銀の弾丸なんて無い。事業の状況、プロダクトの特性、起きている問題を直視して、そのときベストだといえる判断をしていくしかない」と思えた

---

# 立ち上げた事業紹介

- オンライン家庭教師マナリンク
  - オンライン家庭教師が探せるメディア（2024年現在、先生600人）
  - 授業・売上・宿題等の管理ができるSaaS
  - **『メディア的な機能とSaaS的な機能の両方が大事』**
  - Web（Next.js×Laravel）、アプリ（React Native）

<div class="absolute top-8 right-8">
<img class="w-64" alt="Manalink iPhone 12 Pro.png (1.0 MB)" src="https://img.esa.io/uploads/production/attachments/17780/2024/06/24/104467/8d5243bd-6c9e-4ab5-950d-f7d0d89c50de.png">
</div>

---

# カオスなオンライン家庭教師事業立ち上げの中で

- 客観的な状況
  - 人員整理したのでエンジニアは自分含め3〜4名
  - 幸いにもリリース後数ヶ月で売上が立つようになったが、比例して改善が無限に発生。平行してスマホアプリの開発、旧サービスからの一部機能の移行、開発環境整備など。
- 割り切り
  - 大好きなフロントエンド領域は、もうクソコード量産でOK！
  - 今後事業を支えていくバックエンド（DB、インフラ含む）に注力する！
  - インフラﾅﾝﾓﾜｶﾗﾝ中でコンテナベースに移行（今後数年支えるから完遂。今も生きている）
  - **バックエンドをDDD原理主義から適度にカスタマイズ。事業特性と重なるラインを模索**

---

# 当時のTwitter（現X）や技術記事のDDD界隈の印象※個人の感想です

- 「DDDはこうあるべき」VS「そんなんこだわっている暇あったら機能作れ」バトル
- 「DDDに従っていないとまともなプロダクトは作れない的な勘違いや強迫観念」
- 「フロントエンドでドメイン層？何言っているの？」「スタートアップでDDDは愚策」といったコメ
- 「一周回って戦術DDDでもやらないよりはマシ」「戦術DDDはアンチパターン」派の衝突

総じて、”私はこの事業でこの組織でこういう風に”「DDDをやったら上手くいきました」の””内が割愛されて広まり、誤解されている印象を受けた。
発信内容を素直に受け取ればタメになることを言っているのに、前提を誤解されるケースが多そう。

---

# 原理主義的なネットの発信に辟易した結果...

- [ご主人様、小難しいDDDやクリーンアーキテクチャはお忘れになって、”削除しやすい設計”から始められてはいかが？](https://qiita.com/mejileben/items/48473a572ec07cbaf65f)

という煽りタイトルの記事が爆誕した

<img width="500" alt="CleanShot 2024-07-08 at 18.51.07.png (84.9 kB)" src="https://img.esa.io/uploads/production/attachments/17780/2024/07/08/104467/9c34220e-fdc0-439d-9fa2-9526885b2826.png">

---

# 「削除しやすい設計」の例

- ”とにかくわかりやすく”単一責任原則を守れる工夫
  - ControllerやUseCaseは単一のpublic methodを持つ
- 「DDDっぽいよね！」とか「クリーンアーキテクチャっぽいよね！」を重視しない
  - あくまで「削除しやすいこと = 機能が独立して実装されていること」を重視
  - 極端な話、「この処理どこに置いて良いか分からなかったので全部Entityに入れちゃいました」よりも「原理主義的なDomainServiceとは異なりますがとりあえずDomainServiceという命名で切っておきました」のほうが大事と判断

---
layout: section
---

# ここまでを振り返って

以下考えてみましょう

- なぜ弊社ではDDD・クリーンアーキテクチャを遵守しなかったのか？
- なぜ「削除しやすい設計」を心がけたら一旦良いか！に至ったのか？

---

# 観点

- どんなプロダクトを開発しているか？
- ドメインの特徴は何か？
- どんな規模・価値観・スキルの組織か？
- 技術選定は影響しているか？

---

# どんなプロダクトを開発しているか？（再掲）

- オンライン家庭教師マナリンク
  - **『メディア的な先生検索機能とSaaS的な授業管理機能の両方が大事』**
- 設計思想への影響
  - メディア側は色んな先生検索・表示機能がありReadのロジックが複雑
  - SaaS側は授業記録や売上管理がメインで、Writeのロジックが複雑
  - 立ち上げ初期から*ﾏｲｸﾛｻｰﾋﾞｽ*とかやりたくなかったのでモノリスで通したい
  1. 機能群ごとにディレクトリを切り、それぞれDDDやシンプルな設計を使い分ける
  1. CQRSパターンの徹底・EntityをRead Modelにしない

---

# ①機能群ごとにディレクトリ

```sh
├── src/app/Domain
│   ├── Calendar # 授業予定管理機能なのでDDDに寄せる
│   ├── ChatRoom # ただのチャットなのでシンプルに
│   ├── Learning # 宿題などの学習記録管理なのでDDDに寄せる
│   ├── Notification # 通知機能なのでシンプルに
│   ├── OnlineTeaching # オンライン授業機能なのでDDDに寄せる
│   ├── TeacherSearch # 先生検索機能なのでシンプルに
...
```

- DDDの境界づけられたコンテキストやフロントエンドのPackage by Featureに近い
- それぞれの機能群が互いに参照することは稀だが、必要なら許容する※ここで調子に乗って変なデザインパターン入れない。モノリスならIDEで追えるし気に入らないならDeptracしたらいい
- 2020年のサービス立ち上げ初期に取り組み始め、2024年現在もずっと続いている

---

# ②CQRSパターン・EntityをRead Modelにしない

- 事業特性
  - オンライン指導の透明化をミッションにしているから、想定外のReadが後から増えがち
- 課題
  - EntityにRepositoryから使われるわけでもないGetterが増えたり、そもそもMutateやドメインロジックに関係ない無駄なデータを持ってしまい、ほぼDTOになる
- CQRSパターンの徹底
  - EntityをGet時に使わない。更新のための既存データのGetには使う
  - `app/Domain/Hoge/UseCase/Query`以下に特化型のClassが大量に生える

---

# Queryの例

先生が見るカレンダーに表示されるデータ用のクエリ。授業予定もプライベートな予定も両方表示できる数少ない画面なので専用のQueryを用意。Query実装時は必ず唯一のpublicメソッド`handle`を持つことで多目的に使われないようにする。

```php
class MySQLGetCalendarQuery implements GetCalendarQueryInterface
{
    public function __construct(
      private HogeQueryInterface $hogeQuery, private FugaQueryInterface $fugaQuery
    ) {}
    /**
     * 中略
     */
    public function handle(int $teacherId, Carbon $startAt, Carbon $endAt): array
    {
        $lessonSchedules = $this->hogeQuery->handle($teacherId, $startAt, $endAt);
        $hogeSchedules = $this->fugaQuery>handle($teacherId, $startAt, $endAt);

        return [...$lessonSchedules, ...$hogeSchedules];
    }
}
```

---

# ドメインの特徴は何か？

- マナリンクは「ドメイン作りながら設計」
  - オンライン家庭教師はコロナ禍以降メジャーになった新しい事業領域
  - 仕様を決める際に参考になる法律や事例が無いし、ユーザー（先生・ご家庭）も”答え”を知らない
  - さながら「ドメイン駆動設計」ではなく「ドメイン作りながら設計」
- 設計思想への影響
  - ちゃんとビジネス側の”確度”を汲み取って設計レベルに反映する
  - 「事業価値のある機能ならいずれリファクタの機会がある」というポジティブな諦め

---

# 「ドメイン作りながら設計」だと何が起きるか？
- 儲かるかわからないけどきっと価値があるから作る
  - 受託やSaaSとかだと受注ベース・ニーズベースで開発するから”予算”が見えやすい
  - マナリンクでは”オンライン家庭教師はこうあるべき”というリーダーシップで開発する。<br>だから社内での議論を通して設計レベルを見出す
- 意義のある機能はどうせ改善が入る
  - 初期リリースで”当たり”を引くことは少ない。利用率・内容・売上貢献などを見て即改善
  - 「最初はこんな設計で良いだろ。後からどうせリファクタの機会あるよ」が本当に起きる
  - "**機能群ごとにディレクトリ**"作戦がめっちゃ刺さる

---

# どんな規模・価値観・スキルの組織か？

- 全エンジニア3〜5名（2024年現在、5名）
  - 意思決定は爆速
- 学習意欲は高いが、手段の目的化はしないメンバー
  - 「先日学んだデザインパターンをとにかく試したい」といった手段の目的化はしない(信頼)
  - だからこそ、too muchに見える設計を提案されても、CTOはそれを尊重する
  - 設計は失敗経験も必要だと思っている。**機能群ごとにディレクトリ**作戦によって、<br>「この機能にはtoo muchだけど試しにそういう設計するのもOK」という承認が可能

---

# 技術選定は影響しているか？

- 立ち上げ初期からフロントエンドはVue or React、バックエンドはLaravel
  - 設計が苦手なメンバーはしばらくフロントエンド中心にアサインするなど工夫可
- PHPの言語特性
  - PHP7.4や8.0で型周り、OOP周りで相当な進化を遂げたが、一方で限界もある
  - LaravelのDIコンテナが超優秀
  - ほどほどにDDDやクリーンアーキテクチャを取り入れつつ、作り込むも手抜きするも自由
  - 良くも悪くも**言語自体は簡単なので、より本質的な問題解決や設計に集中できる**

*言語自体が難しかったり罠が多かったら、設計頑張る余裕がなくなりそうなので一長一短ですね*

---

# （半分余談）私の志向性

- これまでの話から
  - 個人開発したり新規事業立ち上げるなど、目に見えるプロダクト開発は好き
  - 一方でフロントエンドを追ったりDDD学んだり、学習ももちろん好き
  - 事業を複数回畳んだ経験があり、Too Muchな設計に一家言ある
- 設計文脈においては
  - エヴァンス本も読むし実践DDDも読むしクリーンアーキテクチャも読むし、それを試したい
  - しかし試した結果少しでも”無駄だったな”と思ったら捨てることを全く厭わない
  - **”試して捨てる”ことに意義がある**と思っているから、それ前提の設計ルールを敷くし、<br>メンバーにもチャレンジしてもらうし、個人開発も楽しむ

---
layout: section
---

# 設計思想に至った背景まとめ

---

# 設計思想に至った背景まとめ

1. プロダクト特性から、**臨機応変に設計レベルを決めれることが合理的**
1. ドメインが未確定かつ磨くべき領域のため、**リファクタありきで設計可能**
1. **小規模組織**なので、世間であまり見かけない柔軟な意思決定を求めることが可能
1. 開発メンバーが**学習意欲旺盛かつ手段の目的化はしない**
2. PHPやTypeScriptといった**程々に枯れた技術選定**で設計に集中しやすい
3. CTOが技術大好き＆プロダクト開発大好き＆事業クローズ経験者という背景

---
layout: section
---

# 4月入社の近藤さんに<br>実際のところを訊いてみよう

## 👏👏👏👏👏👏

---

# アジェンダ

1. ここまでの話を聞いてお気持ちを適当にどうぞ（適当）
1. 実際このような設計思想に関わって良いところは？
2. 逆に悪いところ・トレードオフだなと思うところは？

---
layout: section
---

# こっから先は先日のLTで使った物です

---

# DDDやクリーンアーキテクチャに対するスタンス

1. <span>「オンライン家庭教師」という過去に存在しない＆法的にも固まっていないドメインで事業をやるので **『ドメイン駆動開発』というより『ドメイン作りながら開発』**</span>
2. メディア機能はパフォーマンス重視、SaaS機能はドメインロジック重視
3. 組織が4〜5人と小規模なので、強いルールを決めるより個人が自律的に意思決定できることを重視
4. 創業時からPHP＆Laravelを使っているので、PHPの限界やLaravelのルールとの競合を意識

- 以上から
  - 機能群ごとに、設計で何を求めるかが変わる（なので一律でDDDやってますと言い辛い）
  - ある程度以上の「完璧」を求めることのコスパがかなり悪い

---
layout: section
---

# 実際の取捨選択事例集

---

# 取捨選択したもの（バランスor捨てたorこだわり）

1. 【バランス】`app/Domain`以下に機能群ごとに細かく分割し、各自で設計レベルを決定
1. 【捨てた】「ユビキタス言語」は策定しない
2. 【捨てた】「モデリング」は勝負所の機能だけやる
3. 【こだわり】CQRSパターンの徹底・EntityをRead Modelにしない
4. 【捨てた】結合テストは必須・単体テストは「自分を守るため」に書く
5. 【バランス】メンバーの「ここちょっと設計頑張りたいんすよ」は尊重する
6. 【捨てた】いろいろ言ったけど、大して重要じゃない機能の設計不備は割と許す

---

# `app/Domain`以下に機能群ごとに細かく分割

- 事業特性・組織特性
  - マナリンク特有の「メディアとSaaSどっちも大事」
  - フロント出身のメンバーもいるので、設計難度の低い領域を意図的に作れるとうれしい
- Laravelにおける設計
  - `app/Domain/Payment`, `app/Domain/TeacherSearch`といった感じで機能群ごとに分割
  - 前者は決済系なのでいわゆる”DDD”、後者は先生検索機能なのでRead SQL中心
- デメリット
  - 開発者視点では、施策ごとに設計難度が上下する（ただしそれが**要件の難易度と近似**する）

---

# 「ユビキタス言語」は策定しない

- 事業特性
  - マナリンクはITに慣れていない先生や親御さんが多数利用＆特定の法にほぼ依存しない
  - 複雑な用語や仕様にすること自体がアンチパターンのため、用語統一の課題が生まれにくい
- ユビキタス言語のデメリット
  - 「なんかユビキタス言語を元に議論すると良いらしい」みたいに形から入ってしまいがち
  - 事業特性が追いついていないのに策定しても、運用でどうせ風化する
- 今後
  - 今後ずっと不要とは思っていない。課題が表面化してきたら検討します🔥

---

# 「モデリング」は勝負所の機能だけやる

- 事業特性・組織特性
  - 新規の柱である先生検索はRead Heavy・継続の柱である指導支援機能がWrite Heavy
  - （外から想像する以上に）「えっこの機能のこの情報がこっちの機能でいるの？」が多い
  - 例：授業機能で集計された統計情報が、先生一覧のソート順などに影響する
- モデリングとの向き合い方
  - 契約が絡む機能（決済、授業記録など）だけ丁寧にモデリングをする
  - Biz（CEO）にはDDDをやっていると声高に宣言していて、突如要件定義時にモデリングを始めても「ああ、あれか」となるようにしている

---

# CQRSパターンの徹底
- 事業特性
  - オンライン指導の透明化をミッションにしているから、想定外のReadが後から増えがち
- 課題
  - EntityにRepositoryから使われるわけでもないGetterが増えたり、そもそもMutateやドメインロジックに関係ない無駄なデータを持ってしまい、ほぼDTOになる
- CQRSパターンの徹底
  - EntityをGet時に使わない。更新のための既存データのGetには使う
  - `app/Domain/Hoge/UseCase/Query`以下に特化型のClassが大量に生える

---

# Queryの例

先生が見るカレンダーに表示されるデータ用のクエリ。授業予定もプライベートな予定も両方表示できる数少ない画面なので専用のQueryを用意。Query実装時は必ず唯一のpublicメソッド`handle`を持つことで多目的に使われないようにする。

```php
class MySQLGetCalendarQuery implements GetCalendarQueryInterface
{
    public function __construct(
      private HogeQueryInterface $hogeQuery, private FugaQueryInterface $fugaQuery
    ) {}
    /**
     * 中略
     */
    public function handle(int $teacherId, Carbon $startAt, Carbon $endAt): array
    {
        $lessonSchedules = $this->hogeQuery->handle($teacherId, $startAt, $endAt);
        $hogeSchedules = $this->fugaQuery>handle($teacherId, $startAt, $endAt);

        return [...$lessonSchedules, ...$hogeSchedules];
    }
}
```

---

# 結合テストは必須・単体テストは自分を守るため

- 単体テストを必須化するデメリット
  - 設計のアグレッシブな変更に弱い→2次リリース以降でゴリっと改善できない
  - 設計より外枠の、大きな要件の変更に対して”現状維持したい”という余計な引力が働く
  - 単体と結合っていう分け方がそもそもおかしい、みたいなことに向き合わないといけない
- マナリンクでの開発ルール
  - バックエンドのAPIテストは必須。フロントエンド全般と、バックエンドの単体テストは任意
  - 開発していてTDD的に進めたい＆今後改修時に条件網羅で困るといった事情を各自判断して単体テストやフロントエンドテストを実装
  - ※私（CTO）が恐らく世の標準よりかなり”メンバーに任せる”寄りの意思決定者

---

# メンバーの「設計頑張りたいんすよ」は尊重する

- これまでの話を受けて逆張り
  - 私自身「新しい技術を試したい」「新しい作戦を試したい」欲求は強くあれと思っている
  - Too Muchは原則避ける指向性だが、メンバーから「ここは設計頑張りたい」と言われたら尊重することが多い
- そのための技術選定でありアーキテクチャ
  - `app/Domain/Hoge`で切り分ける作戦・何が何でもAPIテストは必須化するラインなど、ギリギリ耐える出口戦略を普段から採るようにしている
  - 開発者自身が最も解像度高いので”設計頑張りたい”という勘は尊重した方が良い
  - 『ハードルを下げるのは技術選定の役目、ハードルを越えるのは各メンバーの役目』

---

# 大して重要じゃない機能の設計不備は割と許す

- 現レビュー体制
  - （まだ小規模なので）原則CTOがレビュー
  - 形だけドメインオブジェクトを使っている・ORMをViewに近いところで使っているなど
- とはいえ
  - 一定の信頼関係の上で、コメント等で補足をしつつ、リリースが近いのでor要件の不透明度が高いといった理由で”汚い”コードも通すことは多い
  - サクッとHogeModelの特定のカラム取りたいだけなのに専用のQuery作って〜とか窮屈なので許すなど。ただし、さすがに許容できないラインも設ける。`$hogeModel->fuga->piyo`といった感じでネストして呼び出すコードはDB構造に強く依存するのでNGなど。

---
layout: section
---

# まとめ

---

# まとめ

1. DDDやクリーンアーキテクチャを厳守しなくても機能は作れるし、事業は進む
2. かといってカオスでメンテナンス性ゼロなコードになるのを恐れる気持ちもわかる
3. 機能群でディレクトリ切るとか、単一publicメソッドなクラスを量産するといった、ちょっと理想的ではないけど、めっちゃ事故にはならない、誰でも60点以上は採れるようなラインを目指す方が現実的なことは多いのでは？
4. 本LTが、目の前の事業や組織やプロダクトに対して、本当に今の開発ルールでいいのか？と自問自答するきっかけになると幸いです

---
layout: section
---

# おわり